% In this file you should put the actual content of the blueprint.
% It will be used both by the web and the print version.
% It should *not* include the \begin{document}
%
% If you want to split the blueprint content into several files then
% the current file can be a simple sequence of \input. Otherwise It
% can start with a \section or \chapter for instance.


\chapter{Big Picture}

\chapter{Monosorted Geometric Logic}
\section{Geometric Signature, Theories and Logic}

\begin{definition}
  %Lean code should be a datatype, how to link that?
A geometric signature contains the information of 
\end{definition}

%\section{Syntactic Site for a Geometric Theory} Previously @KM: is that okay?

\newcommand{\thT}{\ensuremath{\mathcal{T}}}
\newcommand{\fmlInCtx}[2]{\{ #1 | #2 \}}
\newcommand{\subs}[2]{{#1}[{#1}]}
\newcommand{\Univ}{\ensuremath{\mathscr{U}}}
%added
\newcommand{\quot}{\text{quot}}
\newcommand{\vxz}{\vec{x}+\vec{z}}
\newcommand{\vw}{\vec{w}}
\newcommand{\vx}{\vec{x}}
\newcommand{\vy}{\vec{y}}
\newcommand{\vz}{\vec{z}}
\newcommand{\iotas}{\ensuremath{[\iota_1,\iota_2]}}
\newcommand{\xphi}{\vec{x}\mid\phi}
\newcommand{\ypsi}{\vec{y}\mid\psi}
\newcommand{\zzeta}{\vec{z}\mid\zeta}
\newcommand{\ophi}{\overline{\phi}}
\newcommand{\opsi}{\overline{\psi}}
\newcommand{\ozeta}{\overline{\zeta}}
\newcommand{\inl}{\mathsf{inl}}
\newcommand{\inr}{\mathsf{inr}}

\newcommand{\tphi}{\tilde{\phi}}
\newcommand{\tpsi}{\tilde{\psi}}
\newcommand{\tzeta}{\tilde{\zeta}}
\newcommand{\ox}{\overline{x}}
\newcommand{\oz}{\overline{z}}
%added

For the whole section, we fix a geometric theory \thT{} over some universe \Univ{}.

\section{Syntactic Category}
\begin{definition}[Syntactic Category]
  \lean{Joshua.fmlInCtx, Joshua.fmlMap, Joshua.categoryStruct}
  \leanok
  The syntactic category associated to $\mathcal{T}$ has:
  \begin{itemize}
    \item as objects, pairs $\fmlInCtx{\vec{x}}{\varphi}$ of a context $\vec{x} \coloneq x_1, \ldots, x_{n}$ of variables and a geometric formula $\vec{x} \vdash_{\thT} \varphi$ over \thT{};
    \item as morphisms between $\fmlInCtx{\vec{x}}{\varphi}$ and $\fmlInCtx{\vec{y}}{\psi}$, a renaming $\rho : \vec{y} \to \vec{x}$ such that $\vec{x} | \varphi \vdash \subs{\psi}{\rho}$.
  \end{itemize}
\end{definition}



\section{Syntactic Site}
\begin{definition}[Covering family]
  \label{Def:CoveringFamily}
  \lean{WrigleyTopology.CoveringFamily}
  \leanok
  A family of maps $(\rho_k : \fmlInCtx{\vec{x}_k}{\varphi_k}\to \fmlInCtx{\vec{y}}{\psi})_{k \in K}$ with $K \in \Univ$ is covering when
  $\vec{y} | \psi \vdash \bigvee_{k \in K} (\exists \vec{x}_k, \phi \wedge \bigwedge_{i \in \vec{y}} y_i = x_{\rho_k(i)}$).
\end{definition}

This covering family defines a syntactic site:

\begin{definition}[Syntactic Site]
  \lean{WrigleyTopology.SyntacticTopology}
  Define a sieve to be a covering sieve when it contains a covering family as defined in Definition \ref{Def:CoveringFamily}. This requires us to prove the following three lemmas.
\end{definition}

We prove these three conditions in the following three subsections.
\subsection{Identity}
\begin{lemma}[Identity map its own consists of a covering family]
  \lean{WrigleyTopology.id_covers}
  For each object $\vec{x}\mid \phi$ in the syntactic category, the identity map $\{\mathbf{1}_{\vec{x}\mid\phi}\}$ is a covering family.
\end{lemma}

\subsection{Transitivity}
\begin{lemma}[Transitivity]
  \lean{WrigleyTopology.Transitivity.transitivity}
  Given a formula in context $\xphi$ and a two sieves $S,R$ on it, where $S$ is a covering sieve, then if for each arrow $f:\ypsi\to\xphi$ in the
  covering sieve $S$, the pullback of $R$ along $f$ is a covering sieve on $\ypsi$, then $R$ itself is a covering sieve.
\end{lemma}



\subsection{Stability}



\begin{theorem}[Stability of covering sieves]
  If a family $\{g_K\}\to \vec{y}\mid \psi$ is a covering sieve, then the pullback sieve $f^*\{g_K\}$ is a covering sieve on $\xphi$.
\end{theorem}

\begin{proof}
  If $\{g_K\}\to \vec{y}\mid \psi$ is a covering sieve, then it contains a covering family $\{g_k: \to \vec{y}\mid \psi\}$.
  %
  For each of the map $g_{k}:\vec{z_k}\mid \zeta_k$ in the covering family, we consider the object 
  \[C:=\vec{w}\mid \ophi\land \ozeta \land\bigwedge_{i\in \vec{y}} \ox_{f(i)} = \oz_{g(i)}\]. 

  Here we have $\vec{w}:= \vec{x}+ \vec{z}$ is the pushout of $f$ and $\sigma$.

  \[
   \begin{tikzcd}
     \vec{w}\mid \phi\land \zeta \ar[r,"\iota_2"]\ar[d,"\iota_1"]  & \vec{z}\mid \zeta\ar[d,"g"]\\
     \vec{x}\mid \phi \ar[r,"f"] & \vec{y}\mid \psi
   \end{tikzcd}
  \]

  The underlying map $\iota_1:\vx\to\vw$ actually defines a map $C \to \xphi$. 
  %
  For each of $g_k$, we have such a map. And such maps form a covering family on $\xphi$.
  %
  We will prove that we have commutative squares:

  \[
     \begin{tikzcd}
        \vec{w}\mid \ophi\land \ozeta \land\bigwedge_{i\in \vec{y}} \ox_{f(i)} = \oz_{g(i)} \ar[r,"\iota_2"]\ar[d,"\iota_1"]  & \vec{z}\mid \zeta\ar[d,"g"]\\
        \vec{x}\mid \phi \ar[r,"f"] & \vec{y}\mid \psi
     \end{tikzcd}
  \]
  Observe from the above square that the composition $f\circ \iota_1$ is equal to a pre-composition of arrow with an arrow $g\in\{g_K\}$, so each of the composition
   $f\circ \iota_1 \in \{g_K\}$. 
  %
  This proves the maps of the form $\iota_1$ are all in the pullback sieve $f^*\{g_K\}$.
  %
  Hence it is sufficient to prove these $\iota_1$'s form a covering family of $\xphi$.
  %
  We will prove it as the lemma \ref{Lemma:stabCovFam} below.
\end{proof}

\begin{lemma}[Stability of covering families]\label{Lemma:stabCovFam}
  If a family $\{g_k\}\to \vec{y}\mid \psi$ is a covering family, 
  then for each $f: \vec{x}\mid \phi\to \vec{y}\mid\psi$, the pullback of this covering is again a covering family.
\end{lemma}
\begin{proof}
  We want to show that from:
  \[\psi\vdash_{\vy} \bigvee_k \exists \vz_k.\; \tzeta_k\land y_i = z_{g_k(i)}\]
  that 
  \[\phi \vdash_{\vx} \bigvee_k (\exists\vw_k.\;(\ophi\land \ozeta_k \land\bigwedge_{i\in \vec{y}} \ox_{f(i)} = \oz_{g(i)}) \land \bigwedge_{j\in\vec{x}}w_{{\iota^k_1(j)}} = x_j )\]

  We only spell out how to reduce the goal to lemma \ref{Lem:Witness}. After this reduction, we can drop the index $k$ in the proof.

  By definition of map between formulas in context, $f:\xphi\to \ypsi$ gives

  \begin{equation}\label{e1}
   \phi\vdash_{\vx} \psi[x_{f(i)}/y_i]
  \end{equation}
   

  As $\{g_k:\zzeta\to \ypsi\}$ is a covering family on $\ypsi$, by definition \ref{Def:CoveringFamily}, we have 
  \[\psi\vdash_{\vy} \bigvee_k \exists z_k.\;\zeta_k \land \bigwedge_{i\in \vy} y_i = z_{g_k(i)}\]

  By the proof rule on substitution, we have 

  
  \begin{equation}\label{e2}
  \psi [x_{f(i)}/y_i]\vdash_{\vx} (\bigvee_k \exists z_k.\;\zeta_k \land \bigwedge_{i\in \vy} y_i = z_{g_k(i)})  [x_{f(i)}/y_i]
  \end{equation}

  
  where the RHS reduces to, by definition of substitution
  \[\bigvee_k \exists z_k.\;\zeta_k \land \bigwedge_{i\in \vy} x_{f(i)} = z_{g_k(i)}\]
  
  Applying the cut rule on \ref{e1} and \ref{e2} gives
  \[\phi\vdash_{\vx} \bigvee_k \exists z_k.\;\zeta_k \land \bigwedge_{i\in \vy} x_{f(i)} = z_{g_k(i)}\]

  It is sufficient to show
  \begin{equation*}
    \phi\land \bigvee_k \exists z_k.\;\zeta_k \land \bigwedge_{i\in \vy} x_{f(i)} = z_{g_k(i)}\vdash_{\vx}
      \bigvee_k \exists \vw_k. \;(\ophi\land \ozeta_k \land\bigwedge_{i\in \vec{y}} \ox_{f(i)} = \oz_{g(i)}) \land \bigwedge_{j\in\vec{x}}w_{{\iota^k_1(j)}} = x_j  
  \end{equation*}

  Frobinus and distributivity transform the LHS into 
  \begin{equation}
     \bigvee_k \exists z_k. \phi\land \zeta_k \land \bigwedge_{i\in \vy} x_{f(i)} = z_{g_k(i)}
  \end{equation}


  Elimination of existential reduces it into:
  \begin{equation*}
    \phi\land \zeta_k \land \bigwedge_{i\in \vy} x_{f(i)} = z_{g_k(i)} \vdash_{\vx + \vz}
    \exists \vw_k.\;(\ophi\land \ozeta_k \land\bigwedge_{i\in \vec{y}} \ox_{f(i)} = \oz_{g(i)}) \land \bigwedge_{j\in\vec{x}}w_{{\iota^k_1(j)}} = x_j 
  \end{equation*}

  The witness is given by any section of the quotient map $[\iota_1,\iota_2]:\vx + \vz \to \vw$. It reduces the goal to the lemma \ref{Lem:Witness}.
  The index $k$ is now fixed so we are not keeping it from now on.
\end{proof}

  
\begin{lemma}[Witness for the existential quantification in lemma \ref{Lemma:stabCovFam}]\label{Lem:Witness}
  \lean{WrigleyTopology.Stability.coveringWitness}
  \begin{equation*}
    \phi\land \zeta\land \bigwedge_{i\in \vec{y}} x_{f(i)} = z_{\sigma(i)}\vdash_{\vx + \vz} (\overline{\phi}\land \overline{\zeta}\land\bigwedge_{j\in\vec{x}} x_j = w_{\iota_1(j)})[w_l:=(\vxz)_{s(l)}] 
  \end{equation*}
\end{lemma}

\begin{proof}
  Let $\Gamma$ denote the LHS of the sequent. We prove 
  \begin{equation*}
    \Gamma \vdash (\bigwedge_{j\in\vec{x}}x_j = w_{\iota_1(j)}\land \bigwedge_{j'\in\vec{z}}z_{j'}= w_{\iota_2(j')}) [w_l:=(\vxz)_{s(l)}] 
  \end{equation*}

  We prove as the next lemma:
  
  \begin{equation*}
   \bigwedge_{i\in \vec{y}} x_{f(i)} = z_{\sigma(i)} \vdash 
    (\bigwedge_{j\in\vec{x}}x_j = w_{\iota_1(j)}) [w_l:=(\vxz)_{s(l)}] 
  \end{equation*}

  and symmetrically

  \begin{equation*}
    \bigwedge_{i\in \vec{y}} x_{f(i)} = z_{\sigma(i)} \vdash 
    (\bigwedge_{j'\in\vec{z}}z_{j'}= w_{\iota_2(j')}) [w_l:=(\vxz)_{s(l)}] 
  \end{equation*}
  This will prove the equational part of the RHS of lemma \ref{Lem:Witness}, and by congruence of equalities we will have:
  Then as $\ophi := \phi[w_{\iota(j)}/x_j]$, we will have 
  \begin{equation*}
    \phi\land ((\bigwedge_{j\in\vec{x}}x_j = w_{\iota_1(j)})[w_l:=(\vxz)_{s(l)}])  \vdash_{\vx + \vz} \ophi [w_l:=(\vxz)_{s(l)}] 
  \end{equation*}

  
  The proof will need some constructs about \emph{effective quotient}. Relevant definitions and lemmas are below.

  



\end{proof}


\begin{definition}[Relation defined by the equalities in $\Gamma$]
  Relation $R$ is the non-equivalence relation, that only relates pairs of elements in $\vx+\vz$ 
  by the equality part in $\Gamma$. That is 
  \lean{WrigleyTopology.Stability.Rrel}
  \begin{equation}
    R(l_1,l_2):= \text{exists}\; i \in \vy \;\text{such that}\; l_1 = \inl(f(i))\; \text{and}\;  l_2 = \inl(g(i))
  \end{equation}
\end{definition}

\begin{definition}[Relation defined by mapping to the same element in the quotient]
  Relation $S$ is defined by having the same image under the quotient map $\iotas:\vx+\vz\to \vw$. That is 
  \lean{WrigleyTopology.Stability.Srel}
  \begin{equation}
    S(l_1,l_2):= \iotas(l_1) = \iotas(l_2)
  \end{equation}
\end{definition}

\begin{definition}[Equivalence Closure]
  The equivalence closure of an equivalence relation.
  \lean{eqv}
  \leanok
\end{definition}

\begin{definition}[Effective Quotient]
  \lean{effectiveQuotient}
  \leanok
  An effective quotient on a type $\alpha$ is a relation $R$ on $\alpha$ and a carrier set $Q$ represents of the quotient
  set by $R$. With a quotient map $q:\alpha\to Q$ and a section $s:Q\to \alpha$, such that $q\circ s = \mathbf{1}_Q$. Such that:
  \begin{itemize}
    \item soundness: if $R(a_1,a_2)$, then $q(a_1) = q(a_2)$ in the quotient set $Q$.
    \item exactness: if $q(a_1) = q(a_2)$, then $a_1$ and $a_2$ are related by the equivalence closure of $R$.
  \end{itemize}

\end{definition}

\begin{lemma}[1/4 step for covering witness lemma]\label{Lem:CovWit1}
  For each $l\in \vxz$, we have $S((\vxz)_l, (\vxz)_{s(\iotas l)})$
  \lean{WrigleyTopology.Stability.sιsSrel}
\end{lemma}

\begin{lemma}[2/4 step for covering witness lemma]\label{Lem:CovWit2}
  Prove $\iotas$ has a section $s$, hence establish $\vw$ as an effective quotient of $\vx +\vz$ via $\iotas$ and $s$.
  \lean{WrigleyTopology.Stability.ReffectiveQuotient}
  The hardest point is to provide the exactness proof.
  This is effectively proving $S\subset R^*$, where $R^*$ is the equivalence closure of $R$.
\end{lemma}


\begin{lemma}[3/4 step for covering witness lemma]\label{Lem:CovWit3}
  Prove for all $l\in \vxz$, $r\in R^*((\vxz)_l,(\vxz)_{s(\iotas l)})$, we have
  \begin{equation*}
    \Gamma \vdash (\vxz)_l = (\vxz)_{s(\iotas l)}
  \end{equation*}
\end{lemma}

\begin{proof}
  The proof is by induction of the construction of the proof of $R^*$. (Remark: It is doable since we formalize equivalence closure 
  as a type instead of a proposition.)

\begin{itemize}
    \item reflexivity should be according to proof rules for equality, same for symmetry and transitivity.
    \item base case requires us to prove
    \[\Gamma\vdash (\vxz)_{inl(f(i))} = (\vxz)_{inr(\sigma(i))}\]
    LHS is $x_{f(i)}$ and RHS is $z_{\sigma(i)}$, which equals by assumptions in $\Gamma$.
\end{itemize}
\end{proof}

\begin{lemma}[4/4 step for covering witness lemma]\label{Lem:CovWit4}
  \begin{equation*}
    \Gamma \vdash (\bigwedge_{j\in\vec{x}}x_j = w_{\iota_1(j)}\land \bigwedge_{j'\in\vec{z}}z_{j'}= w_{\iota_2(j')}) [w_l:=(\vxz)_{s(l)}]
  \end{equation*}
\end{lemma}

\begin{proof}
  We spell out the proof of 
  \lean{WrigleyTopology.Stability.xφcoveringWitness}
  \begin{equation*}
    \bigwedge_{i\in \vec{y}} x_{f(i)} = z_{\sigma(i)} \vdash 
     (\bigwedge_{j\in\vec{x}}x_j = w_{\iota_1(j)}) [w_l:=(\vxz)_{s(l)}] 
   \end{equation*}
   for illustration. The other half is by symmetry.

  We take the reduction
\[(x_j = w_{\iota_1(j)}) [w_l:=(\vxz)_{s(l)}]\]
\[x_j = (\vxz)_{s(\iota_1(j))}\]
\[(\vxz)_{\inl(j)} = (\vxz)_{s(\iota_1(j))}\]
\[(\vxz)_{\inl(j)} = (\vxz)_{s(\iotas (\inl(j)))}\]
so the final equation is what we want.

This is just the conclusion of lemma \ref{Lem:CovWit3}, taking $l := \inl(j)$.

So we want to show $R^*((\vxz)_l,(\vxz)_{s(\iotas l)})$. By lemma \ref{Lem:CovWit2}, we want to show \[S((\vxz)_{\inl(j)},(\vxz)_{s(\iotas (\inl(j)))})\].

By definition of $S$, it is to prove:

\[\iotas (\inl(j)) = \iotas (s(\iotas (inl(j)))) \]

$\iotas\circ s = 1$ cancels out. Both LHS and RHS is $\iota_1(j)$.

\end{proof}


\begin{comment}
The formulation of stability is centered around the following commutative square.

\[
\begin{tikzcd}
   \vec{w}\mid \phi\land \zeta \ar[r,"\iota_2"]\ar[d,"\iota_1"]  & \vec{z}\mid \zeta\ar[d,"\sigma"]\\
   \vec{x}\mid \phi \ar[r,"f"] & \vec{y}\mid \psi
\end{tikzcd}
\]

where $\vec{w}:= \vec{x}+ \vec{z}$ is the pushout of $f$ and $\sigma$.

with the abuse of notation of denoting a map between formulas and the underlying map between contexts using the same letter, $\vec{w}$ is constructed as:
\[
\begin{tikzcd}
 \vec{y}\ar[d,"f"]\ar[r,"\sigma"] & \vec{z}\ar[d,"\iota_2"]\\
 \vec{x}\ar[r,"\iota_1"] & \vec{w}
\end{tikzcd}
\]






To prove the pullback of a covering sieve is again a covering sieve, we consider a covering family $\{\rho_k\}\to \vec{y}\mid \psi$, and prove that the pullback of this cover



%added


Define relations $R$ and $S$ as follows:

For each $u_1,u_2\in \vec{x}+\vec{z}$,
\[S(u_1,u_2):= [\iota_1,\iota_2]u_1 =  [\iota_1,\iota_2]u_2\]

i.e. $S$ relates $u_1$ and $u_2$ iff $u_1$ is identified with $u_2$ in the quotient.

\[R(inl(x_{f(i)}),inr(z_{\sigma(i)}))\]

Goal: Proving the sequent
\[\phi\land \zeta\land \bigwedge_{i\in \vec{y}} x_{f(i)} = z_{\sigma(i)}\vdash (\overline{\phi}\land \overline{\zeta}\land\bigwedge_{j\in\vec{x}} x_j = w_{\iota_1(j)})[w_l:=(\vxz)_{s(l)}] \]

Let $\Gamma :=$ LHS of the above sequent.

This is achieved in four steps.

Lemma 1 : For each $l\in \vxz$, we have $S((\vxz)_l, (\vxz)_{s(\iotas l)})$

Lemma 2 : Provide the proof of \emph{exact} in the structure \emph{effectiveQuotient}. This is effectively proving $S\subset R^*$, where $R^*$ is the equivalence closure of $R$.

Here $\alpha:= \vxz$, $\quot:= \iotas$

Lemma 3 : Prove for all $l\in \vxz$, $r\in R^*((\vxz)_l,(\vxz)_{s(\iotas l)})$, we have


\[\Gamma \vdash (\vxz)_l = (\vxz)_{s(\iotas l)}\].

The proof is by induction of the construction of the proof of $R^*$.

\begin{itemize}
    \item reflexivity should be according to proof rules for equality, same for symmetry and transitivity.
    \item base case requires us to prove
    \[\Gamma\vdash (\vxz)_{inl(f(i))} = (\vxz)_{inr(\sigma(i))}\]
    LHS is $x_{f(i)}$ and RHS is $z_{\sigma(i)}$, which equals by assumptions in $\Gamma$.
\end{itemize}

Lemma 4 : Prove
\[\Gamma \vdash (\bigwedge_{j\in\vec{x}}x_j = w_{\iota_1(j)}\land \bigwedge_{j'\in\vec{z}}z_{j'}= w_{\iota_2(j')}) [w_l:=(\vxz)_{s(l)}] \]
from Lemma 3.

We take the reduction
\[(x_j = w_{\iota_1(j)}) [w_l:=(\vxz)_{s(l)}]\]
\[x_j = (\vxz)_{s(\iota_1(j))}\]
\[(\vxz)_{inl(j)} = (\vxz)_{s(\iota_1(j))}\]
\[(\vxz)_{inl(j)} = (\vxz)_{s(\iotas (inl(j)))}\]
so the final equation is what we want.

This is just the conclusion of Lemma 3, taking $l := inl(j)$.

So we want to show $R^*((\vxz)_l,(\vxz)_{s(\iotas l)})$. By Lemma 2, we want to show \[S((\vxz)_{inl(j)},(\vxz)_{s(\iotas (inl(j)))})\].

By definition of $S$, it is to prove:

\[\iotas (inl(j)) = \iotas (s(\iotas (inl(j)))) \]

$\iotas\circ s = 1$ cancels out. Both LHS and RHS is $\iota_1(j)$.
\end{comment}
%added